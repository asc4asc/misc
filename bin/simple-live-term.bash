#!/usr/bin/env bash
# simple only for use as live medium!
readonly DISTRI=bookworm # "testing" "stable" "bookworm" "trixie" "bullseye" (oldoldstable oldstable stable testing sid)
# readonly X="" # terminal ohne X 
readonly X="gnome" # "gnome","" terminal ohne X 
readonly BOOT="toram" # "toram","" normal from usb ...
readonly MENU="active" # installed or active after boot
ADD="SIMPLE" #  
#-------------------------------------------------------
[[ ${X} == "gnome" ]] && readonly GNOME=true || readonly GNOME=false
#-------------------------------------------------------
# include to overwite variable? So we do not edit this file?
#-------------------------------------------------------
readonly ICHROOT="/includes.chroot_after_packages"
# add for later use.
readonly DATA4TEST="/etc/skel/DATA"  
readonly DATAHOME="/home/ekf/DATA"  
readonly BIN4TEST="/etc/skel/bin"  
readonly BINHOME="/home/ekf/bin"  
#-------------------------------------------------------

function live-config
{
( mkdir -p $TDIR && cd $TDIR && lb clean  
lb config noauto \
          --mirror-bootstrap "http://deb.debian.org/debian/" \
	  --mirror-binary "http://deb.debian.org/debian/" \
	  --security "false" --updates "false" \
	  --distribution ${DISTRI} \
	  --cache-packages "false" \
	  --archive-areas "main non-free-firmware contrib" \
	  --bootappend-live "boot=live username=ekf ${BOOT} nosplash" \
	  --bootappend-live-failsafe "boot=live ${BOOT} nosplash" \
	  "${@}" 
)
return 0
}

readonly TDIR="live-${X}4term-${BOOT}-${DISTRI}-${ADD}"
echo ${TDIR}
sleep 3

live-config # Erstellen der Grundstrucktur mit einigen Parametern.

${GNOME} && echo task-gnome-desktop >> ${TDIR}/config/package-lists/desktop.list.chroot
${GNOME} && echo gnome-flashback >> ${TDIR}/config/package-lists/desktop.list.chroot

${GNOME} && echo calamares-settings-debian calamares >> ${TDIR}/config/package-lists/installer.list.chroot
${GNOME} && echo qemu-system >> ${TDIR}/config/package-lists/installer.list.chroot

function prepare-bootloader
{
cp -r ${DATAHOME}/bootloaders ${TDIR}/config
cp -r ${DATAHOME}/bootloaders ${TDIR}/config${ICHROOT}${DATA4TEST}/
}
prepare-bootloader

function silent4gnome
{
  mkdir -p ${TDIR}/config/$ICHROOT/etc/skel/.config
  echo "yes" > ${TDIR}/config/$ICHROOT/etc/skel/.config/gnome-initial-setup-done
  return 0
}
silent4gnome

( cd ${TDIR} && lb build )

echo move ${TDIR}/live-image-amd64.hybrid.iso ${TDIR}.iso
mv ${TDIR}/live-image-amd64.hybrid.iso ${TDIR}.iso

qemu-img create -f qcow2 tdrive.img 20G
# kvm -boot c -cdrom ${TDIR}.iso -m 4G -hdd tdrive.img
sudo kvm \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.fd \
  -drive if=pflash,format=raw,file=/usr/share/OVMF/OVMF_VARS.fd \
  -m 4G \
  -cdrom ${TDIR}.iso \
  -hdd tdrive.img \
  -boot c
